================================================================================
ИСПРАВЛЕНИЕ ИЗВЛЕЧЕНИЯ ТЕКСТА ИЗ SERP XML
================================================================================

ПРОБЛЕМА:
---------
В SERP данных от xmlstock текст содержит вложенные XML-теги (например <hlword>):

  <title><hlword>СКУД</hlword> – система <hlword>контроля</hlword></title>

Старый код использовал element.text и получал только None или обрезанный текст.

РЕШЕНИЕ:
--------
Создан новый модуль xml_text_extractor.py который правильно извлекает текст:
- Использует element.itertext() для получения ВСЕГО текста
- Удаляет теги но сохраняет содержимое
- Декодирует HTML entities (&amp;, &nbsp; и т.д.)

ФАЙЛЫ:
------
✓ seo_analyzer/core/xml_text_extractor.py       - новый модуль для извлечения текста
✓ seo_analyzer/core/lemmatizer.py               - НОВЫЙ! Кэшированная лемматизация
✓ seo_analyzer/core/lsi_extractor.py            - обновлен с кэшированной лемматизацией
✓ seo_analyzer/core/serp_data_enricher.py       - обновлен для использования нового экстрактора
✓ test_single_serp_query.py                     - тест одного запроса к API
✓ check_db_text_extraction.py                   - проверка данных в БД
✓ refill_db_from_cache.py                       - переобработка данных в БД
✓ refill_db_fast.py                             - БЫСТРАЯ параллельная переобработка (12 ядер)
✓ clear_serp_database.py                        - очистка БД

ИСПОЛЬЗОВАНИЕ:
--------------

1. ПРОВЕРИТЬ ТЕКУЩИЕ ДАННЫЕ В БД:
   
   python check_db_text_extraction.py
   
   Показывает есть ли необработанные теги в базе данных.

2. ПЕРЕОБРАБОТАТЬ ДАННЫЕ В БД (РЕКОМЕНДУЕТСЯ):
   
   python refill_db_from_cache.py
   
   Читает XML из БД и переобрабатывает с новым кодом.
   Все title, snippet, passages будут очищены от тегов.
   Не требует новых API запросов!

3. ПОЛНАЯ ОЧИСТКА БД (если нужно):
   
   python clear_serp_database.py
   
   Удаляет все данные из БД. Потребуется пересбор через API.

4. ТЕСТ НОВОГО ЗАПРОСА:
   
   python test_single_serp_query.py "ваш запрос"
   
   Делает запрос к API и показывает извлеченные данные.

КОММЕРЧЕСКИЕ ДОМЕНЫ:
--------------------

Q: Как определяется что домен коммерческий?
A: По паттернам в seo_analyzer/core/serp_data_enricher.py:

   commercial_patterns = [
       r'\.shop', r'\.store', r'market', r'shop', r'ozon', r'wildberries',
       r'avito', r'youla', r'aliexpress', r'goods', r'catalog', r'price'
   ]

Например, www.ozon.ru считается коммерческим (паттерн r'ozon').
В БД сохраняется is_commercial = 1.

Можно добавить свои паттерны в __init__ метод класса SERPDataEnricher.

ОПТИМИЗАЦИЯ ЛЕММАТИЗАЦИИ (НОВОЕ!):
----------------------------------

Создан универсальный модуль lemmatizer.py с кэшированием:

✓ @lru_cache(10000 слов) - мгновенное получение часто встречающихся слов
✓ Singleton MorphAnalyzer - словари загружаются один раз в RAM
✓ Ускорение лемматизации в 45+ раз!
✓ Используется везде: LSI, нормализация, дедупликация

Функции для использования в коде:
  from seo_analyzer.core import lemmatize_word, lemmatize_phrase
  
  lemma = lemmatize_word('купить')        # -> 'купить'
  lemma = lemmatize_phrase('купил систему') # -> 'купить система'

РЕКОМЕНДАЦИИ:
-------------

✓ Запустите refill_db_fast.py --workers=12 для БЫСТРОЙ переобработки
✓ Новые запросы будут автоматически использовать оптимизированный код
✓ Проверьте несколько записей через check_db_text_extraction.py
✓ Вся лемматизация в проекте теперь кэшируется автоматически!

================================================================================

