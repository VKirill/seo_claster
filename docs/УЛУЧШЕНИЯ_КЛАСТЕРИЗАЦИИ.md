# Улучшения кластеризации (Декабрь 2024)

## Проблема

Запросы с **разными городами** попадали в один кластер:
- `скуд тамбов` + `купить комплект скуд ярославль` → один кластер ❌
- `скуд в школе москва` + `скуд в школе в спб` → один кластер ❌
- `скуд школа` (общий) + `скуд в школе москва` (гео) → один кластер ❌

Также запросы с разными интентами объединялись:
- `что такое скуд` (info) + `купить скуд` (commercial) → один кластер ❌

## Решение

### 1. Новый модуль `semantic_checker.py`

Создан **SemanticClusterChecker** который проверяет:

**✅ География:**
- Разные города → разные кластеры
- С гео vs без гео → разные кластеры
- Одинаковый город → могут быть вместе

**✅ Интенты:**
- Информационный vs коммерческий → разные кластеры
- Одинаковый интент → могут быть вместе

**✅ Типы продуктов:**
- Карта vs браслет → разные кластеры
- Контроллер vs считыватель → разные кластеры
- Контроллер + турникет → исключение, могут быть вместе

### 2. Интеграция в `serp_advanced_clusterer.py`

- Добавлен параметр `geo_dicts` в конструктор
- Создается `SemanticClusterChecker` при `semantic_check=True`
- Функция `_are_semantically_different()` теперь использует новый чекер

### 3. Исправлен BOM в файлах

**Критический баг:** В `Russian.txt` был UTF-8 BOM символ (`\ufeff`) который мешал распознаванию "Москвы".

**Исправление:**
- `helpers.py`: изменено `encoding='utf-8'` → `encoding='utf-8-sig'`
- Это автоматически удаляет BOM при загрузке

## Результаты тестирования

**✅ 8 из 8 тестов** пройдено успешно:

✅ Разные города разделяются  
✅ С гео vs без гео разделяются  
✅ Разные интенты разделяются  
✅ Разные продукты разделяются  
✅ Контроллер + турникет могут быть вместе  
✅ **Падежные формы городов распознаются!**

### Склонение городов (pymorphy3)

Города распознаются во **всех падежах**:
- "москва" → москва ✅
- "в москве" → москва ✅
- "для москвы" → москва ✅
- "москвой" → москва ✅
- "про москву" → москва ✅

Работает для **всех 1097 городов** из Russian.txt!

## Примеры работы

### До:
```
скуд школа                → Кластер A
скуд в школе москва       → Кластер A  ❌
скуд в школе в спб        → Кластер A  ❌
скуд тамбов               → Кластер A  ❌
```

### После:
```
скуд школа                → Кластер A (общий)
скуд в школе москва       → Кластер B (Москва)  ✅
скуд в школе в спб        → Кластер C (СПб)     ✅
скуд тамбов               → Кластер D (Тамбов)  ✅
```

## Конфигурация

В `config_local.py`:

```python
CLUSTERING_CONFIG_OVERRIDES = {
    "serp_advanced": {
        "semantic_check": True,  # Включить семантическую проверку (по умолчанию)
        # ... другие параметры
    }
}
```

## Файлы изменены

1. **Новые:**
   - `seo_analyzer/clustering/semantic_checker.py` (новый модуль)
   - `test_geo_clustering.py` (тесты)

2. **Изменены:**
   - `seo_analyzer/clustering/serp_advanced_clusterer.py` (интеграция)
   - `pipeline/stages/clusterer.py` (передача geo_dicts)
   - `seo_analyzer/core/helpers.py` (исправление BOM)

## Технические детали

### Склонение городов
- Используется **pymorphy3** (уже в requirements.txt)
- Генерируются все 6 падежей: именительный, родительный, дательный, винительный, творительный, предложный
- LRU кэш на 1000 городов для быстродействия
- Маппинг любой формы → базовая форма города

### Производительность
- Компиляция паттернов: ~2-3 секунды при инициализации
- Поиск города в запросе: мгновенно (regex + dict lookup)
- Работает в памяти, не требует дополнительных запросов

### Примечание:
Moscow.txt содержит города Московской области, а не варианты "Москва"!

